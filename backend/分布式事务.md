# 分布式事务

## 经典事务

ACID 原则：

原子性（A）

所谓的原子性就是说，在整个事务中的所有操作，要么全部完成，要么全部不做，没有中间状态。对于事务在执行中发生错误，所有的操作都会被回滚，整个事务就像从没被执行过一样。

一致性（C）：

事务的执行必须保证系统的一致性，就拿转账为例，A有500元，B有300元，如果在一个事务里A成功转给B50元，那么不管并发多少，不管发生什么，只要事务执行成功了，那么最后A账户一定是450元，B账户一定是350元。

隔离性（I）

所谓的隔离性就是说，事务与事务之间不会互相影响，一个事务的中间状态不会被其他事务感知。

持久性（D）

所谓的持久性，就是说一单事务完成了，那么事务对数据所做的变更就完全保存在了数据库中，即使发生停电，系统宕机也是如此。

## 分布式事务 CAP 理论

CAP定理是由加州大学伯克利分校Eric Brewer教授提出来的，他指出WEB服务无法同时满足一下3个属性：
- 一致性(Consistency) ： 客户端知道一系列的操作都会同时发生(生效)
- 可用性(Availability) ： 每个操作都必须以可预期的响应结束
- 分区容错性(Partition tolerance) ： 即使出现单个组件无法可用,操作依然可以完成

具体地讲在分布式系统中，在任何数据库设计中，一个Web应用至多只能同时支持上面的两个属性。显然，任何横向扩展策略都要依赖于数据分区。因此，设计人员必须在一致性与可用性之间做出选择。


## 分布式事务解决方案 BASE 理论
面对高并发的互联网行业，高可用显然会比一致性要重要的多，但是一致性也是不可抛弃的，如何解决这一矛盾？这个时候，大神们有总结出了BASE理论：
- Basically Available（基本可用）
- Soft state（软状态）
- Eventually consistent（最终一致性）

BASE理论是对CAP中的一致性和可用性进行一个权衡的结果，理论的核心思想就是：我们无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。

## 柔性事务和刚性事务
刚性事务：严格遵循ACID原则的事务, 例如单机环境下的数据库事务。

柔性事务：指遵循BASE理论（基本可用，最终一致）的事务, 通常用在分布式环境中。

常用的柔性事务解决方案有：

1. 两阶段提交（Two Phase Commit, 2PC）
    - 有成熟的解决框架，实现简单。
    - 资源锁定周期长，执行效率低，不适合高并发场景
    - 故障恢复困难

2. TCC补偿型事务（Try-Confirm-Cancle）
    - 实现很复杂，开发成本高
    - 资源锁定粒度小，执行效率高
    - 强隔离性，严格的数据一致性
    - 事务执行周期短

3. 异步确保，基于可靠MQ服务
    - 实现较为复杂，成本略高
    - 对MQ的可靠性要求高
    - 事务执行周期长
    - 最大努力通知
    - 实现简单，成本低
    - 不保证最终一致