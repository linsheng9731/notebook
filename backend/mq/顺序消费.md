# 消息队列如何保证顺序性？

基本思路是对同一个资源的操作进行排序，比如对一笔订单的创建，付款操作是需要有顺序的。这个时候可以通过订单的唯一id进行hash，将相同订单的消息放到同一个顺序队列里。

## rabbitMq

在 MQ 里面创建多个 queue，同一规则的数据（对唯一标识进行 hash），有顺序的放入 MQ 的 queue 里面，消费者只取一个 queue 里面获取数据消费，这样执行的顺序是有序的。或者还是只有一个 queue 但是对应一个消费者，然后这个消费者内部用内存队列做排队，然后分发给底层不同的 worker 来处理。

## kafka

在 kafka 中，你对数据指定某个 key，那么这些数据会到同一个 partition 里面，在 partition 里面这些数据是有顺序的。从这里看没啥问题，插入到数据库的数据都是有序的。

但是，我们在消费端可能会使用多线程来处理，因为单线程的处理速度慢，为了加快处理时间和吞吐量，会使用 thread 来处理。在消费端加入线程之后，就会出现顺序不一致的情况。就是使用了多线程之后，数据顺序不一致情况。

在消费端使用内存队列，队列里的数据使用 hash 进行分发，每个线程对应一个队列，这样可以保证数据的顺序。

## activeMq

activeMq 里面有 messageGroups 属性，可以指定 JMSXGroupID，将需要排序的消息放到同一个 group 里， 消费者会消费指定的 JMSXGroupID。即保证了顺序性，又解决负载均衡的问题。